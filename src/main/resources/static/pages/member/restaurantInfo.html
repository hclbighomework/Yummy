<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script>
        var rName = "";
        var restaurant = new Object();
        var singleName = [];
        var singleNum = [];
        var packageName= [];
        var packageNum = [];
        window.onload = function () {
            var url = window.location.search;
            rName = decodeURI(url.substr(url.indexOf("=") + 1));
            $.ajax({
                    type: "post",
                    async: true,
                    url: "/getShoppingInfo",
                    data: {rName: rName},
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        switch (data.message) {
                            case "error":
                                window.location.href = "/login";
                                break;
                            case "success":
                                restaurant = data.restaurant;
                                document.title = rName + "——Yummy!";
                                $("#userName").html(data.username + "<b class='caret'></b>");
                                $("#rName").text(rName);
                                $("#minCost").text(data.restaurant.minCost + "元");
                                $("#humanCost").text(data.restaurant.humanCost + "元");
                                $("#description").text(data.restaurant.description);
                                setReductionTable(data.restaurant.reductionsByRid);
                                setSingleTable(data.restaurant.singlesByRid);
                                setPackageTable(data.restaurant.packagesByRid);

                        }
                    }
                }
            );
        };
        $(function() {
            $("[data-toggle='popover']").popover({
                html : true,
                title: "商家信息",
                delay:{show:500, hide:1000},
                content: function() {
                    return content();
                }
            });
        });

        function setReductionTable(reductionList) {
            var str = "";
            $.each(reductionList, function (i) {
                str += "<tr><td>" + reductionList[i].fullCost +
                    "</td><td>" + reductionList[i].reduceCost + "</td></tr>";
            });
            if (str == "") {
                str += "<tr><td colspan='2'>无满减优惠</td></tr>"
            }
            $("#reductionTable").html(str);
        }

        function setSingleTable(singleList) {
            var str = "";
            $.each(singleList, function (i) {
                str += "<tr><td>" + singleList[i].name + "</td><td>" + singleList[i].cost +
                    "</td><td>" + singleList[i].type + "</td><td>" +
                    singleList[i].discount + "</td><td>" +
                    singleList[i].num + "</td><td>" +
                    "<input type='number' class='form-control' style='border: none;overflow: hidden;height: 100%;width: 100%;' min='0' max='" +
                    singleList[i].num + "' value='0'></td></tr>"
            });
            $("#singleTable").html(str);
        }

        function setPackageTable(packageList) {
            var str = "";
            $.each(packageList, function (i) {
                str += "<tr><td>" + packageList[i].name + "</td><td>" + packageList[i].cost +
                    "</td><td>" + packageList[i].type + "</td><td>" +
                    packageList[i].discount + "</td><td>" +
                    packageList[i].num + "</td><td>" +
                    "<input type='number' class='form-control' style='border: none;overflow: hidden;height: 100%;width: 100%;' min='0' max='" +
                    packageList[i].num + "' value='0'></td></tr>"
            });
            $("#packageTable").html(str);
            $("#packageTable td").click(function () {
                var index = $(this).parents("tr").find("td").index($(this));
                if (index < 5) {
                    var pName = $(this).closest("tr").find("td").eq(0).html();
                    console.log(pName);
                    showPackage(pName);
                    $("#packageInfoModal").modal("show");
                }

            });
        }
        
        function showPackage(pName) {
            $.ajax({
                    type: "post",
                    async: true,
                    url: "/getPackageInfo",
                    data: {rName: rName, pName: pName},
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        var str = "";
                        $.each(data.packageInfo.singlesCollection, function (i) {
                           str += "<tr><td>" + data.packageInfo.singlesCollection[i].name +
                               "</td><td>" + data.packageInfo.singlesCollection[i].packageNum + "</td></tr>";
                        });
                        $("#packageInfoTable").html(str);
                    }
                }
            );
        }

        function singleSorted(type) {
            $.ajax({
                    type: "post",
                    async: true,
                    url: "/singleSorted",
                    data: {rName: rName, sort:type},
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        setSingleTable(data.singleList);
                    }
                }
            );
        }

        function packageSorted(type) {
            $.ajax({
                    type: "post",
                    async: true,
                    url: "/packageSorted",
                    data: {rName: rName, sort:type},
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        setPackageTable(data.packageList);
                    }
                }
            );
        }

        function content() {
            var rid = restaurant.rid;
            var address = restaurant.addressByAid.description;
            var phone = restaurant.phone;
            return $("<p class='text-muted'>识别码：" + rid + "</p><p class='text-muted'>商家地址："
                + address + "</p><p class='text-muted'>商家电话：" + phone + "</p>");
        }

        function shop() {
            singleNum = [];
            singleName = [];
            packageName = [];
            packageNum = [];
            var money = 0;
            var str = "";
            $("#singleTable tr").each(function () {
               var td = $(this).find("td");
               var name = td.eq(0).html();
               var cost = td.eq(1).html();
               var discount = td.eq(3).html();
               var num = td.eq(4).html();
               var input = td.eq(5).find("input").val();
               if (input > 0 && input <= parseInt(num)) {
                   singleName.push(name);
                   singleNum.push(input);
                   str += "<tr><td>" + name + "</td><td>" + cost +
                       "</td><td>" + discount +
                       "</td><td>" + input + "</td></tr>";
                   money += cost * discount * input * 0.01;
               }
            });
            $("#packageTable tr").each(function () {
                var td = $(this).find("td");
                var name = td.eq(0).html();
                var cost = td.eq(1).html();
                var discount = td.eq(3).html();
                var num = td.eq(4).html();
                var input = td.eq(5).find("input").val();
                if (input > 0 && input <= parseInt(num)) {
                    packageName.push(name);
                    packageNum.push(input);
                    str += "<tr><td>" + name + "</td><td>" + cost +
                        "</td><td>" + discount +
                        "</td><td>" + input + "</td></tr>";
                    money += cost * discount * input * 0.01;
                }
            });
            for (var i = 0; i < restaurant.reductionsByRid.length - 1; i++) {
                if (money >= restaurant.reductionsByRid[i].fullCost && money < restaurant.reductionsByRid[i + 1].fullCost) {
                    money = money - restaurant.reductionsByRid[i].reduceCost;
                    break;
                }
            }
            if (money >= restaurant.reductionsByRid[restaurant.reductionsByRid.length - 1].fullCost) {
                money = money - restaurant.reductionsByRid[restaurant.reductionsByRid.length - 1].reduceCost;
            }
            money += restaurant.humanCost;
            $("#totalMoney").html(money);
            $("#orderTable").html(str);
            if ((singleName.length === 0 && packageName.length === 0) || money < restaurant.minCost) {
                $("#payBtn").attr('disabled', true);
            } else {
                $("#payBtn").attr('disabled', false);
            }
            $("#shoppingInfoModal").modal("show");
        }

        function setOrder() {
            console.log(singleName);
            var note = $("#noteArea").val();
            var cost = $("#totalMoney").html();
            console.log(cost);
            $.ajax({
                    type: "post",
                    async: true,
                    url: "/setOrder",
                    data: {singleName: singleName, singleNum: singleNum, packageName: packageName, packageNum: packageNum, rName:rName, note:note, cost:cost},
                    dataType: 'json',
                    traditional:true,
                    success: function (data) {
                        console.log(data);
                        switch (data.message) {
                            case "success":
                                window.location.href = "/order_detail?oid=" + data.oid;
                                break;
                            default:
                                window.location.href = "/login";
                        }
                    }
                }
            );
        }
    </script>
</head>
<body>
<style>
    .navbar{
        position: relative;
        min-height: 50px;
        margin-bottom: 1px;
        background-color: #2492d6;
        border: 1px solid transparent;
    }
    a{
        color: white;
    }
    .input-group a{
        color: black;
        font-size: 16px;
    }

    .background{
        margin-top: 10px;
        width: 100%;
        height: 150px;
    }

    .noticeT{
        position: absolute;
        left:1030px;
        width: 250px;
        height: 30px;
        background-color: #40b7ff;
        text-align:center;
        border-radius: 2px;
    }

    .notice{
        position: absolute;
        top:255px;
        left:1030px;
        width: 250px;
        height: 250px;
        border: #c4b3b3 1px solid;
        padding: 10px 10px 10px 10px;
    }



    .food{
        width: 95%;
        height: 80px;
        border: #c4b3b3 1px solid;
        float: left;
        margin:-10px 20px 20px 0;
        border-radius: 8px;
    }

    .orderPane{
        width: 820px;
        float: left;
        position: absolute;
        left: 200px;
        top:225px;

        height:auto;
        overflow:hidden
    }

    .orderPane1{
        width: 820px;
        float: left;
        position: relative;
        left: 200px;
        top:800px;

        height:auto;
        overflow:hidden
    }



    .orderedFood{
        width: 100%;
        border-bottom: #c4b3b3 1px solid  ;
        height: 30px;
        float: left;
    }

    .price{
        background-color: #3e4c4b;
        width: 66.67%;
        height: 40px;
        margin-top: 5px;
    }

    .singleName{
        margin-top: 25px;
        margin-left: 50px;
        font-size: 18px;
        font-weight: bold;
        width: 15%;
        height: 35px;
    }

    .singlePrice{
        margin-top: 20px;
        margin-left: 10px;
        font-size: 18px;
        font-weight: bold;
        width: 15%;
        height: 35px;
    }

    .singleNum{
        margin-top: 20px;
        margin-left: 10px;
        font-size: 18px;
        font-weight: bold;
        width: 17%;
        height: 35px;
    }

    .singleImg{
        margin-top: 0px;
        margin-left: 10px;

        width: 60px;
        height: 60px;
        border-radius: 8px;
    }

    .singleButton{
        margin-top:-5px;
        margin-left: 10px;
        width: 12%;
        height: 35px;
        font-size: 12px;
    }

    .shoppingNum{
        width: 15%;
        height: 35px;
        margin-top: 15px;
        margin-left: 10px;
    }

    .shoppingName{
        font-size: 14px;
        font-weight: bold;
        margin-left: 10px;
        width: 60%;
    }

    .shoppingPrice{
        font-size: 14px;
        font-weight: bold;
        margin-left: 5px;
        width: 30%;
    }

</style>
<nav class="navbar navbar-expand-sm bg-dark navbar-dark fixed-top" role="navigation" style="background-color: rgba(44,123,255,0.85); height: 60px; font-size: 20px">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#"><img src="../../image/yummy2.png" style="height: 30px; width: 80px"></a>
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li style="width: 120px;text-align: center"><a href="/member_main">首页</a></li>
                <li style="width: 120px;text-align: center"><a href="/member_order">我的订单</a></li>
            </ul>
        </div>
        <div class="collapse navbar-collapse justify-content-end">
            <ul class="nav navbar-nav">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" id="userName">
                        userName
                        <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="/member_profile">个人中心</a></li>
                        <li><a href="/member_consume">消费统计</a></li>
                        <li><a href="/login">登出</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="background">
    <img class="img-circle" src="../../image/restaurant_icon/Mcc.jpg" style="border-radius: 50%;
    position: relative; top:20px; left:200px;" width="100px" height="100px">
    <label style="font-size: 20px;   font-weight: bold; position: relative; top:0px; left:260px;" id="resName">麦当劳餐厅</label>
    <label style="font-size: 14px;  width:80px;font-weight: bold; position: absolute; top:110px; left:950px;">起送价</label>
    <label style="font-size: 14px; width:80px;font-weight: bold; position: absolute; top:110px; left:1085px;">配送费</label>
    <label style="font-size: 14px; width:80px;font-weight: bold; position: absolute; top:110px; left:1220px;" >满减优惠</label>
    <label style="font-size: 17px; width:80px;font-weight: bold; position: absolute; top:150px; left:950px;">20元</label>
    <label style="font-size: 17px; width:80px;font-weight: bold; position: absolute; top:150px; left:1085px;">配送费￥5</label>
    <label style="font-size: 17px; width:80px;font-weight: bold; position: absolute; top:150px; left:1220px;" id="resDiscount">满45减20</label>
</div>


<div class="orderPane" id="singlePane">
    <label style="width: 98%; font-size: 20px; font-weight: bold; border-bottom: #c4b3b3 2px solid">单品</label>
    <div class="food">
        <img src="../../image/restaurant_icon/Mcc.jpg" class="singleImg">
        <label class="singleName" id="singleName">汉堡</label>
        <label class="singlePrice" id="singlePrice">￥20.0</label>
        <label class="singleNum" id="singleNum">库存：20</label>
        <input type="text" class="shoppingNum">
        <button class="btn btn-primary singleButton" id="singleButton">加入购物车</button>
    </div>
    <div class="food"></div>
    <div class="food"></div>
    <div class="food"></div>
    <div class="food"></div>
    <div class="food"></div>



</div>

<div class="orderPane1" id="setPane">
    <label style="width: 98%; font-size: 20px; font-weight: bold; border-bottom: #c4b3b3 2px solid"  title="Header" data-toggle="popover" data-placement="right" data-content="Content">套餐</label>
    <div class="food">
        <img src="../../image/restaurant_icon/Mcc.jpg" class="singleImg">
        <label class="singleName" >汉堡</label>
        <label class="singlePrice" >￥20.0</label>
        <label class="singleNum" >库存：20</label>
        <input type="text" class="shoppingNum">
        <button class="btn btn-primary singleButton" >加入购物车</button>
    </div>
</div>

<div class="noticeT"><label style="font-weight: bold; font-size: 16px; color: white">商 家 公 告</label></div>
<div class="notice"><p style="font-size: 15px" id="resNotice">兄弟萌，现在商家酬宾大减价，快来抢抢抢！满45减20，你买不了吃亏买不了上当</p></div>

<div class="card" style=" position:  fixed;bottom: 0; right: 0;z-index: 999;padding: 0px 0px 0px 0px ">
    <div class="card-header" style="width: 300px; height: 50px "  >
        <a class="card-link" data-toggle="collapse" href="#collapseOne">
            购物车
        </a>
    </div>
    <div id="collapseOne" class="collapse show" data-parent="#accordion"  style="width: 300px; height: auto;
     padding: 0px 0px 0px 0px">
        <div class="card-body" id="shoppingCar">

            <div class="orderedFood"> </div>
            <div class="orderedFood"> </div>
            <div class="orderedFood"> </div>


        </div>
    </div>
    <div class="price" ><label style="margin-left: 50px ; margin-top:10px;font-size: 18px; font-weight: bold;
    color: white" id="price" >总价：200元</label></div>
    <button type="button" class="btn btn-primary" style="height: 40px;  width: 100px; position: fixed; bottom: 1px; right: 1px;"
            id="payButton">支 付</button>
</div>


</body>
</html>